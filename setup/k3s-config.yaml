# K3s Configuration for Edge Deployment (Raspberry Pi ARM64)
# This file is referenced during K3s installation to apply edge-optimized settings.

# Kubeconfig permissions (644 allows non-root kubectl access)
write-kubeconfig-mode: "644"

# Data directory (default, explicit for clarity)
data-dir: "/var/lib/rancher/k3s"

# Disable heavy components to save ~100MB RAM on edge devices
disable:
  - traefik        # Save ~60-80MB. Use NodePort for now; ingress later if justified
  - servicelb      # Save ~30-40MB. Not needed for single-node or external LB scenarios
  - metrics-server # Explicitly disabled in Phase 1; Prometheus comes in Phase 4
  # local-path storage remains enabled (default) for basic PVC support

# Kubelet settings for low-memory edge environments
kubelet-arg:
  # Hard eviction: immediately terminate pods when memory < 100Mi available
  # Prevents OOM killer from targeting system/K8s processes
  - "eviction-hard=memory.available<100Mi,nodefs.available<10%"

  # Soft eviction: grace period before terminating pods
  # Gives workloads 2 minutes to handle memory pressure
  - "eviction-soft=memory.available<200Mi,nodefs.available<15%"
  - "eviction-soft-grace-period=memory.available=2m,nodefs.available=2m"

  # Reserve resources for host OS (adjust based on Pi RAM: 128Mi/256Mi/384Mi)
  # Ensures system processes don't get starved by workloads
  - "system-reserved=memory=256Mi,cpu=250m"

  # Reserve resources for Kubernetes control plane components
  # Prevents workload pods from degrading cluster stability
  - "kube-reserved=memory=256Mi,cpu=250m"

  # Limit max pods to prevent runaway creation on constrained hardware
  - "max-pods=50"

# Reduce API server log verbosity to minimize disk I/O (SD card longevity)
kube-apiserver-arg:
  - "v=1"

# Reduce controller manager log verbosity
kube-controller-manager-arg:
  - "v=1"

# Reduce scheduler log verbosity
kube-scheduler-arg:
  - "v=1"

# Embedded SQLite datastore (default for single-node)
# Lighter than etcd (~15-20MB less memory), simpler recovery
# Sufficient for edge single-node deployments
